#!/bin/bash

# Function to validate IP address
function validate_ip() {
    local ip=$1
    local valid_ip_regex="^([0-9]{1,3}\.){3}[0-9]{1,3}$"
    if [[ $ip =~ $valid_ip_regex ]]; then
        return 0
    else
        return 1
    fi
}

# Check if WAN address is provided as a positional parameter
if [ -z "$1" ]; then
    echo "Usage: $0 <WAN IP address>"
    exit 1
fi

WAN=$1

# Validate WAN address
if ! validate_ip $WAN; then
    echo "Invalid WAN address. Please enter a valid IP address."
    exit 1
fi

# Prompt user for output folder
echo "Enter the output folder"
read -p 'Output: ' Output

# Check if output folder is writable
if [ ! -d "$Output" ]; then
    echo "Output folder does not exist. Creating folder."
    mkdir -p $Output
elif [ ! -w "$Output" ]; then
    echo "Output folder is not writable. Please check permissions or path"
    exit 1
fi

# Define output file name based on WAN address and current timestamp
timestamp=$(date +%Y%m%d_%H%M%S)
output_file="$Output/scan_${WAN}_$timestamp.txt"

# Execute nmap scan. Using very aggressive timing, change to lower if needed.
echo "Starting nmap scan on $WAN. Results will be saved to $output_file"
nmap -T5 --min-rate=1000 --max-retries=1 --host-timeout=30m -p- -Pn -oN $output_file $WAN

echo -e "\e[1;31m nmap scan completed. Results saved to $output_file \e[0m"
